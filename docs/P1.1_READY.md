# P1.1: Performance Testing & Improvement - Ready to Run

## ✅ 準備完了

計測機能（P1.0）は実装済み。次は実測テストと改善です。

---

## 📋 実行フロー（推奨）

### Phase 1: テスト実行（10分）

**ドキュメント:** `spotify-shopper/docs/QUICK_RUN.md`

```bash
# ターミナル1
cd /Users/takumimaki/dev/spotify-shopper
PYTHONPATH=/Users/takumimaki/dev/spotify-shopper \
  /Users/takumimaki/dev/.venv/bin/python -m uvicorn app:app --host 127.0.0.1 --port 8000

# ターミナル2
cd /Users/takumimaki/dev/spotify-shopper-web
NEXT_PUBLIC_BACKEND_URL="http://127.0.0.1:8000" npm run dev

# ブラウザ: http://localhost:3000
# DevTools Console (F12) を開いて、以下を実行:
# 1. ハード更新 (Cmd+Shift+R)
# 2. Spotify URL 入力: https://open.spotify.com/playlist/3cEYpjA9oz9GiPac4AsrlZ
# 3. "Analyze" クリック → [PERF] ログをコピペ
# 4. 同じ URL でもう2回（warm run 1, 2）
```

### Phase 2: 結果記入（5分）

**ドキュメント:** `spotify-shopper/docs/PERF_RESULTS.md`

- Console `[PERF]` ログを貼り付け
- Backend terminal `[PERF]` ログを貼り付け
- 3回分（cold + warm 2回）

### Phase 3: 分析（5分）

**ドキュメント:** `spotify-shopper/docs/P1.1_IMPLEMENTATION_GUIDE.md`

数値を見て、以下のどれが当てはまるか判定:

```
Case A: network_ms > 1000ms
        → TTL キャッシュ実装（10分）

Case B: render_ms > 500ms
        → React 最適化実装（15分）

Case C: xml_ms > 500ms
        → マッチング最適化実装（30分）

Case D: 全て < 500ms
        → 改善不要
```

### Phase 4: 改善実装（オプション、15-30分）

実装案のコード例を参考に実装

---

## 📂 ドキュメント配置

```
spotify-shopper/
  └─ docs/
      ├─ START_HERE.md ............................ エントリーポイント
      ├─ QUICK_RUN.md ............................ テスト実行（10分）
      ├─ PERF_RESULTS.md ......................... テスト結果テンプレート
      ├─ P1.1_IMPLEMENTATION_GUIDE.md ........... 改善案とコード例
      ├─ PERF_TESTING.md ........................ 詳細テストガイド
      ├─ P1.0_IMPLEMENTATION.md ................ 計測実装説明
      └─ TEST_CHECKLIST.md ..................... テストチェックリスト

spotify-shopper-web/
  └─ docs/
      ├─ START_HERE.md .......................... フロント側ガイド
      └─ QUICK_PERF_TEST.md .................... クイックテスト
```

---

## 🎯 期待される測定値（参考）

**Spotify プレイリスト（70-100トラック）**

| メトリクス | Cold Run | Warm Run 1 | Warm Run 2 | 期待範囲 |
|----------|---------|-----------|-----------|---------|
| network_ms | 450 | 50 | 50 | 10-1000 |
| json_ms | 28 | 28 | 28 | 10-100 |
| render_ms | 120 | 120 | 120 | 50-500 |
| total_ms | 600 | 200 | 200 | 100-1500 |

**Warm Run で network_ms が削減されたら、キャッシュ効果あり**

---

## 🔍 よくある結果パターン

### パターン1: network_ms が支配（予想）

```
Cold Run:   network_ms=450, json_ms=28, render_ms=120 → total_ms=600
Warm Run 1: network_ms=50,  json_ms=28, render_ms=120 → total_ms=200
```

**判定:** Spotify fetch が遅い  
**対策:** TTL キャッシュ  
**実装案:** `P1.1_IMPLEMENTATION_GUIDE.md` の Case A

### パターン2: render_ms が支配

```
Cold Run:   network_ms=450, json_ms=28, render_ms=1200 → total_ms=1700
Warm Run:   network_ms=50,  json_ms=28, render_ms=1200 → total_ms=1300
```

**判定:** React 描画が遅い  
**対策:** displayedTracks memo化、仮想スクロール  
**実装案:** `P1.1_IMPLEMENTATION_GUIDE.md` の Case B

### パターン3: 全て高速

```
Cold Run:   total_ms=350
Warm Run:   total_ms=150
```

**判定:** 現状 OK  
**対策:** 改善不要  
**次:** 本番環境で検証

---

## ✋ 実装時のポイント

1. **計測ログは常に出しておく**
   - 改善前後の `[PERF]` ログで効果検証

2. **最小変更**
   - キャッシュなら TTLCache 1つ追加
   - React なら useMemo 追加のみ
   - マッチング なら インデックス作成のみ

3. **コミット時に結果を記録**
   - Commit message: `P1.1: add TTL cache (network_ms 450→50)`

---

## 🚀 今すぐ実行

```bash
# QUICK_RUN.md を開く
open /Users/takumimaki/dev/spotify-shopper/docs/QUICK_RUN.md

# テスト実行（10分）
# → PERF_RESULTS.md に記入（5分）
# → P1.1_IMPLEMENTATION_GUIDE.md で分析（5分）
# → 必要なら実装（15-30分）
```

---

**テスト結果をお待ちします！** 🎯
