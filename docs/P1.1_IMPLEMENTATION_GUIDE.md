# P1.1: æ”¹å–„å®Ÿè£…ã‚¬ã‚¤ãƒ‰

## æº–å‚™

è¨ˆæ¸¬ãƒ†ã‚¹ãƒˆçµæœï¼ˆcold/warm ã® [PERF] ãƒ­ã‚°ï¼‰ã‚’ `PERF_RESULTS.md` ã«è¨˜å…¥

---

## ã‚¹ãƒ†ãƒƒãƒ— 1: ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ¤å®š

ãƒ†ã‚¹ãƒˆçµæœã®æ•°å€¤ã‚’è¦‹ã¦ã€ä»¥ä¸‹ã®ã©ã‚ŒãŒå½“ã¦ã¯ã¾ã‚‹ã‹åˆ¤å®š:

```
Case A: network_ms > 1000ms ï¼ˆCold Runï¼‰
        â†’ Spotify/Apple fetch ãŒé…ã„
        â†’ å¯¾ç­–: TTL ã‚­ãƒ£ãƒƒã‚·ãƒ¥

Case B: render_ms > 500ms ï¼ˆã©ã® Run ã§ã‚‚ï¼‰
        â†’ React æç”»ãŒé…ã„
        â†’ å¯¾ç­–: displayedTracks memoåŒ– + ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«

Case C: xml_ms > 500ms ï¼ˆXML ãŒã‚ã‚‹å ´åˆï¼‰
        â†’ Rekordbox ç…§åˆãŒé…ã„
        â†’ å¯¾ç­–: ãƒãƒƒãƒãƒ³ã‚°æœ€é©åŒ–

Case D: ã™ã¹ã¦ < 500ms
        â†’ ç¾çŠ¶OKã€æ”¹å–„ä¸è¦
```

---

## å®Ÿè£…æ¡ˆ A: TTL ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆSpotify fetchï¼‰

**å®Ÿè£…å ´æ‰€:** `backend/core.py` ã® `fetch_playlist_tracks()` é–¢æ•°

**æ‰‹é †:**

1. `cachetools.TTLCache` ã‚’ä½¿ç”¨
2. Playlist URL ã‚’æ­£è¦åŒ–ï¼ˆ`?si=...` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‰Šé™¤ï¼‰
3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ TTL = 6æ™‚é–“ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ / 24æ™‚é–“ï¼ˆæœ¬ç•ªï¼‰

**ã‚³ãƒ¼ãƒ‰ä¾‹:**

```python
from cachetools import TTLCache
import time

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
_spotify_cache = TTLCache(maxsize=1000, ttl=6*3600)  # 6æ™‚é–“

def fetch_playlist_tracks(playlist_id_or_url: str) -> Dict[str, Any]:
    # URL æ­£è¦åŒ–
    normalized_key = normalize_spotify_url(playlist_id_or_url)
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
    if normalized_key in _spotify_cache:
        logger.info(f"[CACHE HIT] {normalized_key}")
        return _spotify_cache[normalized_key]
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã— â†’ å–å¾—
    logger.info(f"[CACHE MISS] {normalized_key}")
    result = _fetch_from_spotify(playlist_id_or_url)
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
    _spotify_cache[normalized_key] = result
    return result
```

**æœŸå¾…åŠ¹æœ:**
- Cold Run: network_ms = 450msï¼ˆå¤‰ã‚ã‚‰ãšï¼‰
- Warm Run 1: network_ms = 10-50ms ï¼ˆæœ€å¤§90%å‰Šæ¸›ï¼‰
- Warm Run 2: network_ms = 10-50ms

**å®Ÿè£…æ™‚é–“:** 10-15åˆ†

---

## å®Ÿè£…æ¡ˆ B: React æœ€é©åŒ–ï¼ˆrender_msï¼‰

**å®Ÿè£…å ´æ‰€:** `frontend/app/page.tsx` ã® `handleAnalyze()` å‘¨è¾º

**æ‰‹é †:**

1. `displayedTracks` è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ `useMemo` ã§ãƒ¡ãƒ¢åŒ–
2. TrackRow ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåŒ– + `React.memo`
3. å¤§é‡ãƒˆãƒ©ãƒƒã‚¯æ™‚ï¼ˆ>500ï¼‰ã¯ `react-window` æ¤œè¨

**ã‚³ãƒ¼ãƒ‰ä¾‹:**

```typescript
// Before
const displayedTracks = useMemo(() => {
  let filtered = currentResult.tracks;
  if (categoryFilter === 'toBuy') {
    filtered = filtered.filter((t) => t.owned === false);
  }
  // ... filtering/sorting logic
  return filtered;
}, [currentResult, categoryFilter, searchQuery, sortKey]);

// TrackRow ã‚’ memoåŒ–
const TrackRowMemo = React.memo(TrackRow);
```

**æœŸå¾…åŠ¹æœ:**
- render_ms: 300ms â†’ 80-120ms ï¼ˆ60%å‰Šæ¸›ï¼‰

**å®Ÿè£…æ™‚é–“:** 15-20åˆ†

---

## å®Ÿè£…æ¡ˆ C: Rekordbox ãƒãƒƒãƒãƒ³ã‚°æœ€é©åŒ–ï¼ˆxml_msï¼‰

**å®Ÿè£…å ´æ‰€:** `backend/rekordbox.py` ã® `mark_owned_tracks()` é–¢æ•°

**æ‰‹é †:**

1. ãƒãƒƒãƒãƒ³ã‚°ã‚­ãƒ¼ï¼ˆISRC, artist+titleï¼‰ã‚’ãƒãƒƒã‚·ãƒ¥ã‚»ãƒƒãƒˆåŒ–
2. 4æ®µéšãƒãƒƒãƒã‚’ fail-fast ã§å®Ÿè£…
3. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆdictï¼‰ã‚’äº‹å‰æ§‹ç¯‰

**ã‚³ãƒ¼ãƒ‰ä¾‹:**

```python
def mark_owned_tracks(tracks, rekordbox_xml_path):
    # XML ãƒ‘ãƒ¼ã‚¹
    rb_collection = parse_rekordbox_xml(rekordbox_xml_path)
    
    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰ï¼ˆäº‹å‰ï¼‰
    isrc_index = {t['isrc']: t for t in rb_collection if t['isrc']}
    key_index = {normalize_key(t): t for t in rb_collection}
    
    # ãƒãƒƒãƒãƒ³ã‚°ï¼ˆfail-fastï¼‰
    for track in tracks:
        # æ®µéš1: ISRC
        if track.get('isrc') and track['isrc'] in isrc_index:
            track['owned'] = True
            track['owned_reason'] = 'isrc'
            continue
        
        # æ®µéš2: exact
        key = normalize_key(track)
        if key in key_index:
            track['owned'] = True
            track['owned_reason'] = 'exact'
            continue
        
        # ... æ®µéš3,4
```

**æœŸå¾…åŠ¹æœ:**
- xml_ms: 1200ms â†’ 600ms ï¼ˆ50%å‰Šæ¸›ï¼‰

**å®Ÿè£…æ™‚é–“:** 20-30åˆ†

---

## å„ªå…ˆåº¦ã¨å®Ÿè£…é †åº

| å„ªå…ˆåº¦ | æ¡ˆ | åŠ¹æœ | å®Ÿè£…æ™‚é–“ | è¤‡é›‘åº¦ |
|--------|----|----|--------|--------|
| **HIGH** | A: TTL ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | 90% | 10åˆ† | ä½ |
| **MEDIUM** | B: React æœ€é©åŒ– | 60% | 15åˆ† | ä¸­ |
| **LOW** | C: ãƒãƒƒãƒãƒ³ã‚°æœ€é©åŒ– | 50% | 30åˆ† | é«˜ |

**æ¨å¥¨:** çµæœã‚’è¦‹ã¦ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯1ã¤ã‚’æœ€å°å¤‰æ›´ã§å®Ÿè£…ã™ã‚‹

---

## å®Ÿè£…ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### å‰æº–å‚™
- [ ] PERF_RESULTS.md ã« test results ã‚’è¨˜å…¥
- [ ] ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’åˆ¤å®š
- [ ] å¯¾å¿œã™ã‚‹å®Ÿè£…æ¡ˆã‚’é¸æŠ

### å®Ÿè£…ä¸­
- [ ] ã‚³ãƒ¼ãƒ‰ä¿®æ­£
- [ ] lint: `npm run lint` / `pylint` ã§ãƒã‚§ãƒƒã‚¯
- [ ] è¨ˆæ¸¬ãƒ­ã‚°ã®ç¢ºèªï¼ˆ[PERF] ãƒ­ã‚°ã¯æ®‹ã‚‹ï¼‰

### å®Ÿè£…å¾Œ
- [ ] build ç¢ºèªï¼ˆ`npm run build` / `python -m py_compile`ï¼‰
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã§ cold/warm ãƒ†ã‚¹ãƒˆå†å®Ÿè¡Œ
- [ ] æ”¹å–„å‰å¾Œã® [PERF] ãƒ­ã‚°ã‚’æ¯”è¼ƒ

### Commit & Push
- [ ] Commit message: `P1.1: <æ”¹å–„å†…å®¹> (network/render/xml)`
- [ ] `git push`

---

## Q&A

**Q: è¤‡æ•°ã®å®Ÿè£…æ¡ˆã‚’åŒæ™‚ã«é€²ã‚ã‚‰ã‚Œã‚‹ï¼Ÿ**
A: Yes. backend/frontend ã¯ç‹¬ç«‹ãªã®ã§ä¸¦åˆ—å¯èƒ½ã€‚ãŸã ã—è¨ˆæ¸¬ãƒ†ã‚¹ãƒˆã¯é †åºã¯å½±éŸ¿ã—ãªã„ã€‚

**Q: æ”¹å–„åŠ¹æœãŒå‡ºãªã„å ´åˆï¼Ÿ**
A: `[PERF]` ãƒ­ã‚°ã§æ”¹å–„å‰å¾Œã‚’æ¯”è¼ƒã€‚æ”¹å–„ãŒåæ˜ ã•ã‚Œã¦ãªã„ãªã‚‰ implementation è¦‹ç›´ã—ã€‚

**Q: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ã©ã“ã«ä¿å­˜ï¼Ÿ**
A: æœ€å°: ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªï¼ˆ`cachetools.TTLCache`ï¼‰ã€‚æœ¬ç•ª: Redis/Memcached æ¤œè¨ã€‚

---

**ğŸ‘‰ ãƒ†ã‚¹ãƒˆçµæœã‚’å¾…ã£ã¦ã‹ã‚‰å®Ÿè£…å†…å®¹ã‚’ç¢ºå®šã—ã¾ã™**
