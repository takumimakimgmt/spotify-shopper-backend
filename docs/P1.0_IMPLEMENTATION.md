# P1.0 Performance Metrics Implementation Summary

## å®Ÿè£…å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

âœ… **ãƒ•ãƒ­ãƒ³ãƒˆå´è¨ˆæ¸¬å®Œäº†** (app/page.tsx)
âœ… **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´è¨ˆæ¸¬å®Œäº†** (app.py, core.py)
âœ… **ãƒ†ã‚¹ãƒˆæ‰‹é †ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ** (QUICK_PERF_TEST.md, PERF_TESTING.md)

---

## è¨ˆæ¸¬å†…å®¹

### ãƒ•ãƒ­ãƒ³ãƒˆå´ (Browser Console)

**è¨ˆæ¸¬ç‚¹:**
- `t0`: analyzeé–‹å§‹ (fetchç›´å‰)
- `t1`: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡
- `t2`: JSON.parseå®Œäº†
- `t3a`: stateæ›´æ–°ç›´å‰
- `t3b`: 2x requestAnimationFrameï¼ˆReact renderå®Œäº†ï¼‰

**å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:**
```
[PERF] url=<URL> tracks=<N> network_ms=<X.X> json_ms=<Y.Y> render_ms=<Z.Z> total_ms=<T.T> payload_bytes=<B>
```

**ãƒ¡ãƒˆãƒªã‚¯ã‚¹:**
- **network_ms**: fetchæ™‚é–“ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ + ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ï¼‰
- **json_ms**: JSON.parseæ™‚é–“
- **render_ms**: React state updateï½renderå®Œäº†ï¼ˆ2x RAFï¼‰
- **total_ms**: å…¨ä½“æ™‚é–“
- **payload_bytes**: JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ã‚º

---

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ (Server Logs)

**core.py ã®å¤‰æ›´:**
- `fetch_playlist_tracks_generic()` ãŒå„å‡¦ç†ã®æ™‚é–“ã‚’è¨ˆæ¸¬
- æˆ»ã‚Šå€¤ã® `result` dict ã« `'perf'` ã‚­ãƒ¼ã‚’è¿½åŠ 
  - `perf['fetch_ms']`: ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå–å¾—æ™‚é–“
  - `perf['enrich_ms']`: ISRC enrichmentæ™‚é–“ï¼ˆApple Musicæ™‚ã®ã¿ï¼‰
  - `perf['total_ms']`: coreå†…ã§ã®å…¨å‡¦ç†æ™‚é–“
  - `perf['tracks_count']`: ãƒˆãƒ©ãƒƒã‚¯æ•°

**app.py ã®å¤‰æ›´:**

**`/api/playlist` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**
```python
[PERF] source=<spotify|apple> url_len=<N> fetch_ms=<X.X> enrich_ms=<Y.Y> total_backend_ms=<Z.Z> total_api_ms=<T.T> tracks=<N>
```

**`/api/playlist-with-rekordbox-upload` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**
```python
[PERF] source=<spotify|apple> url_len=<N> fetch_ms=<X.X> xml_ms=<Y.Y> total_ms=<Z.Z> tracks=<N>
```

**ãƒ¡ãƒˆãƒªã‚¯ã‚¹:**
- **fetch_ms**: ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå–å¾—ï¼ˆSpotify API / Apple Playwrightï¼‰
- **enrich_ms**: ISRC enrichmentï¼ˆAppleã®ã¿ISRC enrichmentå®Ÿæ–½ï¼‰
- **xml_ms**: Rekordbox XMLç…§åˆ
- **total_backend_ms**: coreå‡¦ç†åˆè¨ˆ
- **total_api_ms**: appå…¨ä½“ï¼ˆfetchï½playlist_result_to_dictï½ãƒ­ã‚°ï¼‰
- **tracks**: ãƒˆãƒ©ãƒƒã‚¯æ•°

---

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•

### ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆï¼ˆ5åˆ†ï¼‰

```bash
# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
cd /Users/takumimaki/dev/spotify-shopper
PYTHONPATH=/Users/takumimaki/dev/spotify-shopper \
  /Users/takumimaki/dev/.venv/bin/python -m uvicorn app:app --host 127.0.0.1 --port 8000

# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2: ãƒ•ãƒ­ãƒ³ãƒˆ
cd /Users/takumimaki/dev/spotify-shopper-web
NEXT_PUBLIC_BACKEND_URL="http://127.0.0.1:8000" npm run dev

# ãƒ–ãƒ©ã‚¦ã‚¶: http://localhost:3000
# DevTools Console ã‚’é–‹ã„ã¦ [PERF] ãƒ­ã‚°ã‚’ç¢ºèª
```

è©³ç´°: `QUICK_PERF_TEST.md` ã‚’å‚ç…§

---

## è¨ˆæ¸¬çµæœã®è¦‹æ–¹

### ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ

| network_ms | json_ms | render_ms | è§£é‡ˆ |
|-----------|---------|-----------|------|
| 200-1000  | <50     | <200      | âœ… Spotifyæ­£å¸¸ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ãŒæ”¯é…çš„ï¼‰|
| 1000+     | <50     | <200      | ğŸŸ¡ Apple Music or å¤§è¦æ¨¡ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ |
| <200      | >100    | <200      | ğŸŸ¡ ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å¤§ãã„ï¼ˆtrackså¤šã„ï¼‰ |
| <500      | <50     | >500      | ğŸŸ¡ React renderingé…ã„ï¼ˆæœ€é©åŒ–æ¤œè¨ï¼‰ |

### ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ¤å®š

1. **network_ms ãŒå¤§ãã„** â†’ Spotify API / Apple scraping ãŒé…ã„
   - å¯¾ç­–: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆTTL 6-24hï¼‰

2. **render_ms ãŒå¤§ãã„** â†’ React state/rendering ãŒé…ã„
   - å¯¾ç­–: displayedTracks memoæœ€é©åŒ–ã€Track row memocacheã€ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«

3. **xml_ms ãŒå¤§ãã„** â†’ Rekordboxç…§åˆãŒé…ã„
   - å¯¾ç­–: ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯æœ€é©åŒ–ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ã€frontend lazy load

---

## å®Ÿè£…ã®è©³ç´°

### ãƒ•ãƒ­ãƒ³ãƒˆå®Ÿè£…ç®‡æ‰€

**ãƒ•ã‚¡ã‚¤ãƒ«:** `/Users/takumimaki/dev/spotify-shopper-web/app/page.tsx`

**é–¢æ•°:** `handleAnalyze()` å†…

```typescript
// t0: analyzeé–‹å§‹
const t0 = performance.now();

// ... fetchå®Ÿæ–½ ...

// t1: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡
const t1 = performance.now();
const networkMs = t1 - t0;

// t2: JSON parse
const t2 = performance.now();
const jsonMs = t2 - t1;

// ... state set ...

// t3a/t3b: React render
const t3a = performance.now();
// ... newResults.push ...

requestAnimationFrame(() => {
  requestAnimationFrame(() => {
    const t3b = performance.now();
    const renderMs = t3b - t3a;
    // ... console.log [PERF] ...
  });
});
```

**è¨ˆæ¸¬ç¯„å›²:**
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯: fetché–‹å§‹ï½response.text()å®Œäº†
- JSON: JSON.parseæ™‚é–“
- Render: state.setMultiResults()ï½æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆ2x RAFï¼‰

---

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…ç®‡æ‰€

**ãƒ•ã‚¡ã‚¤ãƒ«1:** `/Users/takumimaki/dev/spotify-shopper/core.py`

**é–¢æ•°:** `fetch_playlist_tracks_generic()`

```python
def fetch_playlist_tracks_generic(source: str, url_or_id: str) -> Dict[str, Any]:
    import time
    t0_total = time.time()
    
    perf = {
        'fetch_ms': 0,
        'enrich_ms': 0,
        'total_ms': 0,
        'tracks_count': 0,
    }
    
    if src == "apple":
        t0_fetch = time.time()
        result = fetch_apple_playlist_tracks_from_web(url_or_id)
        t1_fetch = time.time()
        perf['fetch_ms'] = (t1_fetch - t0_fetch) * 1000
        
        t0_enrich = time.time()
        result = _enrich_apple_tracks_with_spotify(result)
        t1_enrich = time.time()
        perf['enrich_ms'] = (t1_enrich - t0_enrich) * 1000
    else:
        t0_fetch = time.time()
        result = fetch_playlist_tracks(url_or_id)
        t1_fetch = time.time()
        perf['fetch_ms'] = (t1_fetch - t0_fetch) * 1000
    
    result['perf'] = perf
    t1_total = time.time()
    perf['total_ms'] = (t1_total - t0_total) * 1000
    perf['tracks_count'] = len(result.get('items', []))
    return result
```

**ãƒ•ã‚¡ã‚¤ãƒ«2:** `/Users/takumimaki/dev/spotify-shopper/app.py`

**é–¢æ•°1:** `get_playlist()` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```python
@app.get("/api/playlist", response_model=PlaylistResponse)
def get_playlist(...):
    import time
    t0_total = time.time()
    
    result = fetch_playlist_tracks_generic(src, clean_url)
    perf = result.get('perf', {})
    data = playlist_result_to_dict(result)
    
    t1_total = time.time()
    total_ms = (t1_total - t0_total) * 1000
    tracks_count = len(data.get('tracks', []))
    logger.info(
        f"[PERF] source={src} url_len={len(clean_url)} "
        f"fetch_ms={perf.get('fetch_ms', 0):.1f} "
        f"enrich_ms={perf.get('enrich_ms', 0):.1f} "
        f"total_backend_ms={perf.get('total_ms', 0):.1f} "
        f"total_api_ms={total_ms:.1f} "
        f"tracks={tracks_count}"
    )
    return data
```

**é–¢æ•°2:** `playlist_with_rekordbox_upload()` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```python
@app.post("/api/playlist-with-rekordbox-upload", response_model=PlaylistResponse)
async def playlist_with_rekordbox_upload(...):
    import time
    t0_total = time.time()
    
    t0_fetch = time.time()
    result = fetch_playlist_tracks_generic(src, clean_url)
    t1_fetch = time.time()
    fetch_ms = (t1_fetch - t0_fetch) * 1000
    
    # ... XML handling ...
    
    t0_xml = time.time()
    playlist_with_owned = _apply_rekordbox_owned_flags(playlist_data, tmp_path)
    t1_xml = time.time()
    xml_ms = (t1_xml - t0_xml) * 1000
    
    t1_total = time.time()
    total_ms = (t1_total - t0_total) * 1000
    tracks_count = len(playlist_with_owned.get('tracks', []))
    logger.info(
        f"[PERF] source={src} url_len={len(clean_url)} "
        f"fetch_ms={fetch_ms:.1f} xml_ms={xml_ms:.1f} total_ms={total_ms:.1f} "
        f"tracks={tracks_count}"
    )
    return playlist_with_owned
```

---

## Git ã‚³ãƒŸãƒƒãƒˆ

| Repository | Commit | Message |
|-----------|--------|---------|
| spotify-shopper | 8210d5f | feat: add performance metrics logging (P1.0) |
| spotify-shopper-web | f47fa0c | feat: add performance metrics logging (P1.0) |

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### Phase 2: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ & çµæœåˆ†æ

1. **QUICK_PERF_TEST.md** ã«å¾“ã£ã¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
2. Cold Run vs Warm Run ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®š
3. çµæœã‚’ `PERF_TESTING.md` ã® "å®Ÿè¡Œä¾‹" ã«è¨˜éŒ²

### Phase 3: æœ€é©åŒ–ï¼ˆçµæœã«åŸºã¥ãï¼‰

**optionA: network_ms ãŒæ”¯é…çš„**
```
â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥å°å…¥ï¼ˆTTL 6-24hï¼‰
  - Spotify: playlist URLæ­£è¦åŒ– + TTL cache
  - Apple: shorter TTL (1-6h)
  - Render.com `render-cache` ãƒ˜ãƒƒãƒ€ãƒ¼æ¤œè¨
```

**optionB: render_ms ãŒæ”¯é…çš„**
```
â†’ Reactæœ€é©åŒ–
  - displayedTracks memoåŒ–ï¼ˆuseMemoä¾å­˜æœ€é©åŒ–ï¼‰
  - TrackRow ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåŒ– + React.memo
  - å¤§é‡ãƒˆãƒ©ãƒƒã‚¯æ™‚ã¯ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆreact-windowï¼‰
```

**optionC: xml_ms ãŒæ”¯é…çš„**
```
â†’ Rekordboxç…§åˆæœ€é©åŒ–
  - ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ã€binary search
  - Frontend: "Load owned links" lazy load
  - Backend: XML ãƒ‘ãƒ¼ã‚¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥
```

---

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | ç”¨é€” |
|--------|------|
| `QUICK_PERF_TEST.md` | 5åˆ†ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã§ãã‚‹ã‚¯ã‚¤ãƒƒã‚¯ã‚¬ã‚¤ãƒ‰ |
| `PERF_TESTING.md` | è©³ç´°ãªãƒ†ã‚¹ãƒˆæ‰‹é †ãƒ»è§£é‡ˆãƒ»æœ€é©åŒ–ã‚¬ã‚¤ãƒ‰ |
| `P1.0_IMPLEMENTATION.md` | ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå®Ÿè£…æ¦‚è¦ï¼‰ |

---

## è³ªå•ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q: [PERF] ãƒ­ã‚°ãŒå‡ºãªã„

A: ä»¥ä¸‹ã‚’ç¢ºèª
1. NEXT_PUBLIC_BACKEND_URL ãŒæ­£ã—ã„ã‹
2. ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ "Filter" ãŒ [PERF] ã‚’é™¤å¤–ã—ã¦ã„ãªã„ã‹
3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰/ãƒ•ãƒ­ãƒ³ãƒˆä¸¡æ–¹èµ·å‹•ã—ã¦ã„ã‚‹ã‹
4. ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã« analyze ã‚’å®Ÿè¡Œã—ãŸã‹

### Q: network_ms ãŒã¨ã¦ã‚‚é•·ã„ï¼ˆ>5sï¼‰

A: æ­£å¸¸ã§ã™ã€‚Apple Music ã®å ´åˆã¯ Playwright scraping ãŒé…ã„ã€‚å¤§è¦æ¨¡ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚‚åŒæ§˜ã€‚

### Q: render_ms ãŒ 1000ms ä»¥ä¸Š

A: React rendering ãŒé…ã„å¯èƒ½æ€§ã€‚Trackæ•°ã¨ãƒ–ãƒ©ã‚¦ã‚¶ã‚¹ãƒšãƒƒã‚¯ç¢ºèªã€‚ãƒ‡ãƒãƒƒã‚°ç”¨ã« React Profiler ä½¿ç”¨ã€‚

---

æœ€å¾Œã«: è¨ˆæ¸¬æ©Ÿèƒ½ã¯ã€Œæ¨æ¸¬ãªã—ã«æ•°å­—ã§æœ€é©åŒ–ã™ã‚‹ã€ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚çµæœã‚’è¦‹ãŸå¾Œã«æ–½ç­–ã‚’æ±ºå®šã—ã¦ãã ã•ã„ï¼
